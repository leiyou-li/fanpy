name: Sync Sites Configuration

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview mode (do not modify files)'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - 'spider.json'
    branches:
      - main
  schedule:
    - cron: '30 0 * * *'

jobs:
  sync-sites:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Configure Git
        run: |
          git config user.name "sites-sync[bot]"
          git config user.email "sites-sync[bot]@users.noreply.github.com"

      - name: Check files existence
        id: check_files
        run: |
          if [ -f "spider.json" ]; then
            echo "spider_exists=true" >> $GITHUB_OUTPUT
          else
            echo "spider_exists=false" >> $GITHUB_OUTPUT
          fi
          if [ -f "moyun.json" ]; then
            echo "moyun_exists=true" >> $GITHUB_OUTPUT
          else
            echo "moyun_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create scripts directory
        if: steps.check_files.outputs.spider_exists == 'true' && steps.check_files.outputs.moyun_exists == 'true'
        run: mkdir -p scripts

      - name: Run sites sync
        if: steps.check_files.outputs.spider_exists == 'true' && steps.check_files.outputs.moyun_exists == 'true'
        id: sync_sites
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          
          if python scripts/sync_sites.py $DRY_RUN_FLAG; then
            echo "sync_success=true" >> $GITHUB_OUTPUT
            
            if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
              if git diff --quiet moyun.json; then
                echo "has_changes=false" >> $GITHUB_OUTPUT
              else
                echo "has_changes=true" >> $GITHUB_OUTPUT
                SITES_COUNT=$(python -c "
import json
try:
    with open('moyun.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    print(len(data.get('sites', [])))
except:
    print(0)
")
                echo "sites_count=$SITES_COUNT" >> $GITHUB_OUTPUT
              fi
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "sync_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.sync_sites.outputs.sync_success == 'true' && steps.sync_sites.outputs.has_changes == 'true'
        run: |
          git add moyun.json
          git commit -m "Update sites configuration"
          git push origin main

      - name: Generate summary
        if: always()
        run: |
          echo "# Sites Configuration Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Sync Time**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**Mode**: Preview (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode**: Normal" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## File Check" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_files.outputs.spider_exists }}" == "true" ]; then
            echo "- spider.json: Found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- spider.json: Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check_files.outputs.moyun_exists }}" == "true" ]; then
            echo "- moyun.json: Found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- moyun.json: Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check_files.outputs.spider_exists }}" == "true" ] && [ "${{ steps.check_files.outputs.moyun_exists }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Sync Result" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.sync_sites.outputs.sync_success }}" == "true" ]; then
              if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
                echo "- Preview mode completed successfully" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ steps.sync_sites.outputs.has_changes }}" == "true" ]; then
                echo "- Configuration updated and committed" >> $GITHUB_STEP_SUMMARY
                echo "- Sites count: ${{ steps.sync_sites.outputs.sites_count }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- No changes needed" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- Sync failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi