name: Sync Sites Configuration

on:
  # å¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®žé™…ä¿®æ”¹æ–‡ä»¶ï¼‰'
        required: false
        default: 'false'
        type: boolean
  
  # å½“spider.jsonæ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘
  push:
    paths:
      - 'spider.json'
    branches:
      - main
  
  # æ¯å¤©é¢å¤–è¿è¡Œä¸€æ¬¡ç¡®ä¿åŒæ­¥
  schedule:
    - cron: '30 0 * * *'  # åŒ—äº¬æ—¶é—´08:30 (UTC 00:30)

jobs:
  sync-sites:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Configure Git
        run: |
          git config user.name "sites-sync[bot]"
          git config user.email "sites-sync[bot]@users.noreply.github.com"

      - name: Check files existence
        id: check_files
        run: |
          if [ -f "spider.json" ]; then
            echo "spider_exists=true" >> $GITHUB_OUTPUT
          else
            echo "spider_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ spider.json ä¸å­˜åœ¨"
          fi
          
          if [ -f "moyun.json" ]; then
            echo "moyun_exists=true" >> $GITHUB_OUTPUT
          else
            echo "moyun_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ moyun.json ä¸å­˜åœ¨"
          fi

      - name: Create scripts directory
        if: steps.check_files.outputs.spider_exists == 'true' && steps.check_files.outputs.moyun_exists == 'true'
        run: mkdir -p scripts

      - name: Run sites sync
        if: steps.check_files.outputs.spider_exists == 'true' && steps.check_files.outputs.moyun_exists == 'true'
        id: sync_sites
        run: |
          echo "ðŸ”„ å¼€å§‹åŒæ­¥sitesé…ç½®..."
          
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "ðŸ” è¿è¡Œåœ¨é¢„è§ˆæ¨¡å¼"
          fi
          
          # è¿è¡ŒåŒæ­¥è„šæœ¬
          if python scripts/sync_sites.py $DRY_RUN_FLAG; then
            echo "sync_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Sitesé…ç½®å¤„ç†æˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤ï¼ˆéžé¢„è§ˆæ¨¡å¼ï¼‰
            if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
              if git diff --quiet moyun.json; then
                echo "has_changes=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ moyun.json æ— éœ€æ›´æ–°"
              else
                echo "has_changes=true" >> $GITHUB_OUTPUT
                echo "ðŸ“ moyun.json å·²æ›´æ–°"
                
                # èŽ·å–ç»Ÿè®¡ä¿¡æ¯
                SITES_COUNT=$(python -c "
import json
try:
    with open('moyun.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    sites_count = len(data.get('sites', []))
    print(f'sites_count={sites_count}')
except:
    print('sites_count=0')
" | grep sites_count | cut -d'=' -f2)
                echo "sites_count=$SITES_COUNT" >> $GITHUB_OUTPUT
              fi
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "sync_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Sitesé…ç½®å¤„ç†å¤±è´¥"
          fi

      - name: Commit and push changes
        if: steps.sync_sites.outputs.sync_success == 'true' && steps.sync_sites.outputs.has_changes == 'true'
        run: |
          echo "ðŸ“ æäº¤é…ç½®å˜æ›´..."
          
          git add moyun.json
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_MSG="ðŸ”§ Auto-sync sites configuration
          
          ðŸ“Š é…ç½®ç»Ÿè®¡:
          - Sitesæ•°é‡: ${{ steps.sync_sites.outputs.sites_count }}
          - åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}
          
          ðŸ”„ åŒæ­¥æ¥æº: spider.json â†’ moyun.json
          ðŸ¤– è‡ªåŠ¨åŒæ­¥: GitHub Actions"
          
          git commit -m "$COMMIT_MSG"
          git push origin main
          
          echo "âœ… é…ç½®å˜æ›´å·²æäº¤å¹¶æŽ¨é€"

      - name: Generate summary
        if: always()
        run: |
          echo "# ðŸ”§ Sitesé…ç½®åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC ($(date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**è¿è¡Œæ¨¡å¼**: ðŸ” é¢„è§ˆæ¨¡å¼ï¼ˆæœªä¿®æ”¹æ–‡ä»¶ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "**è¿è¡Œæ¨¡å¼**: âœ… æ­£å¸¸æ¨¡å¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ–‡ä»¶æ£€æŸ¥ç»“æžœ
          echo "## ðŸ“ æ–‡ä»¶æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_files.outputs.spider_exists }}" == "true" ]; then
            echo "- âœ… spider.json å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ spider.json ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check_files.outputs.moyun_exists }}" == "true" ]; then
            echo "- âœ… moyun.json å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ moyun.json ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          # åŒæ­¥ç»“æžœ
          if [ "${{ steps.check_files.outputs.spider_exists }}" == "true" ] && [ "${{ steps.check_files.outputs.moyun_exists }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ”„ åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.sync_sites.outputs.sync_success }}" == "true" ]; then
              if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
                echo "- âœ… é¢„è§ˆæ¨¡å¼è¿è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ steps.sync_sites.outputs.has_changes }}" == "true" ]; then
                echo "- âœ… é…ç½®å·²æ›´æ–°å¹¶æäº¤" >> $GITHUB_STEP_SUMMARY
                echo "- ðŸ“Š Sitesæ•°é‡: ${{ steps.sync_sites.outputs.sites_count }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- â„¹ï¸ é…ç½®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ è·³è¿‡åŒæ­¥" >> $GITHUB_STEP_SUMMARY
            echo "ç”±äºŽå¿…è¦æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡sitesé…ç½®åŒæ­¥ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
