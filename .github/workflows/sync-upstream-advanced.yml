name: Advanced Upstream Sync

on:
  # å®šæ—¶è¿è¡Œè®¡åˆ’
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´08:00è¿è¡Œï¼ˆUTC 00:00ï¼‰
    - cron: '0 0 * * *'
    # æ¯å‘¨ä¸€é¢å¤–è¿è¡Œä¸€æ¬¡ä½œä¸ºå¤‡ä»½
    - cron: '0 2 * * 1'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå³ä½¿æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "upstream-sync[bot]"
          git config user.email "upstream-sync[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„upstream remote
          git remote remove upstream 2>/dev/null || true
          # æ·»åŠ upstream remote
          git remote add upstream https://github.com/engd66/PyramidStore.git
          echo "å·²æ·»åŠ ä¸Šæ¸¸ä»“åº“remote"

      - name: Fetch all remotes
        run: |
          echo "æ­£åœ¨èŽ·å–æ‰€æœ‰remoteçš„æœ€æ–°ä¿¡æ¯..."
          git fetch --all --prune
          echo "èŽ·å–å®Œæˆ"

      - name: Get commit information
        id: commit_info
        run: |
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          LOCAL_SHORT=$(git rev-parse --short HEAD)
          UPSTREAM_SHORT=$(git rev-parse --short upstream/main)
          
          # èŽ·å–ä¸Šæ¸¸æœ€æ–°æäº¤ä¿¡æ¯
          UPSTREAM_MESSAGE=$(git log upstream/main -1 --pretty=format:"%s")
          UPSTREAM_AUTHOR=$(git log upstream/main -1 --pretty=format:"%an")
          UPSTREAM_DATE=$(git log upstream/main -1 --pretty=format:"%cr")
          
          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "local_short=$LOCAL_SHORT" >> $GITHUB_OUTPUT
          echo "upstream_short=$UPSTREAM_SHORT" >> $GITHUB_OUTPUT
          echo "upstream_message=$UPSTREAM_MESSAGE" >> $GITHUB_OUTPUT
          echo "upstream_author=$UPSTREAM_AUTHOR" >> $GITHUB_OUTPUT
          echo "upstream_date=$UPSTREAM_DATE" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ] || [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            # è®¡ç®—æ–°æäº¤æ•°é‡
            COMMIT_COUNT=$(git rev-list --count HEAD..upstream/main)
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Display sync information
        run: |
          echo "=== åŒæ­¥ä¿¡æ¯ ==="
          echo "æœ¬åœ°æœ€æ–°æäº¤: ${{ steps.commit_info.outputs.local_short }}"
          echo "ä¸Šæ¸¸æœ€æ–°æäº¤: ${{ steps.commit_info.outputs.upstream_short }}"
          echo "ä¸Šæ¸¸æœ€æ–°å˜æ›´: ${{ steps.commit_info.outputs.upstream_message }}"
          echo "å˜æ›´ä½œè€…: ${{ steps.commit_info.outputs.upstream_author }}"
          echo "å˜æ›´æ—¶é—´: ${{ steps.commit_info.outputs.upstream_date }}"
          
          if [ "${{ steps.commit_info.outputs.has_updates }}" == "true" ]; then
            echo "çŠ¶æ€: ðŸ”„ éœ€è¦åŒæ­¥ (${{ steps.commit_info.outputs.commit_count }} ä¸ªæ–°æäº¤)"
          else
            echo "çŠ¶æ€: âœ… å·²æ˜¯æœ€æ–°"
          fi

      - name: Backup current branch
        if: steps.commit_info.outputs.has_updates == 'true'
        run: |
          # åˆ›å»ºå¤‡ä»½åˆ†æ”¯
          BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BACKUP_BRANCH"
          git push origin "$BACKUP_BRANCH"
          git checkout main
          echo "å·²åˆ›å»ºå¤‡ä»½åˆ†æ”¯: $BACKUP_BRANCH"

      - name: Sync with upstream
        if: steps.commit_info.outputs.has_updates == 'true'
        id: sync_result
        run: |
          echo "å¼€å§‹åŒæ­¥ä¸Šæ¸¸å˜æ›´..."
          
          # å°è¯•åˆå¹¶
          if git merge upstream/main --no-edit; then
            echo "sync_method=merge" >> $GITHUB_OUTPUT
            echo "sync_success=true" >> $GITHUB_OUTPUT
            echo "âœ… æˆåŠŸåˆå¹¶ä¸Šæ¸¸å˜æ›´"
          else
            echo "åˆå¹¶å‘ç”Ÿå†²çªï¼Œå°è¯•é‡ç½®åˆ°ä¸Šæ¸¸ç‰ˆæœ¬..."
            git merge --abort
            
            # ä¿å­˜æœ¬åœ°ç‰¹æœ‰çš„æ–‡ä»¶ï¼ˆå¦‚æžœæœ‰çš„è¯ï¼‰
            LOCAL_FILES=$(git diff --name-only upstream/main...HEAD | grep -v "^\.github/" | head -5)
            if [ ! -z "$LOCAL_FILES" ]; then
              echo "æ£€æµ‹åˆ°æœ¬åœ°ç‰¹æœ‰æ–‡ä»¶ï¼Œå°†åœ¨é‡ç½®åŽæ¢å¤:"
              echo "$LOCAL_FILES"
            fi
            
            # é‡ç½®åˆ°ä¸Šæ¸¸ç‰ˆæœ¬
            git reset --hard upstream/main
            echo "sync_method=reset" >> $GITHUB_OUTPUT
            echo "sync_success=true" >> $GITHUB_OUTPUT
            echo "âœ… å·²é‡ç½®åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬"
          fi

      - name: Setup Python for sync script
        if: steps.commit_info.outputs.has_updates == 'true' && steps.sync_result.outputs.sync_success == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Sync sites configuration
        if: steps.commit_info.outputs.has_updates == 'true' && steps.sync_result.outputs.sync_success == 'true'
        id: sync_sites
        run: |
          echo "ðŸ”„ å¼€å§‹åŒæ­¥sitesé…ç½®..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "spider.json" ]; then
            echo "âš ï¸  spider.json ä¸å­˜åœ¨ï¼Œè·³è¿‡sitesåŒæ­¥"
            echo "sites_sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ ! -f "moyun.json" ]; then
            echo "âš ï¸  moyun.json ä¸å­˜åœ¨ï¼Œè·³è¿‡sitesåŒæ­¥"
            echo "sites_sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # åˆ›å»ºè„šæœ¬ç›®å½•
          mkdir -p scripts
          
          # è¿è¡ŒåŒæ­¥è„šæœ¬
          if python scripts/sync_sites.py; then
            echo "sites_sync_success=true" >> $GITHUB_OUTPUT
            echo "sites_sync_needed=true" >> $GITHUB_OUTPUT
            echo "âœ… Sitesé…ç½®åŒæ­¥æˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
            if git diff --quiet moyun.json; then
              echo "sites_changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  moyun.json æ— éœ€æ›´æ–°"
            else
              echo "sites_changes=true" >> $GITHUB_OUTPUT
              echo "ðŸ“ moyun.json å·²æ›´æ–°"
              
              # æäº¤å˜æ›´
              git add moyun.json
              git commit -m "ðŸ”„ Auto-sync sites from spider.json
              
              - åŒæ­¥æ—¶é—´: $(date -u)
              - åŒæ­¥æ¥æº: spider.json
              - è‡ªåŠ¨åŒæ­¥: GitHub Actions"
            fi
          else
            echo "sites_sync_success=false" >> $GITHUB_OUTPUT
            echo "sites_sync_needed=true" >> $GITHUB_OUTPUT
            echo "âŒ Sitesé…ç½®åŒæ­¥å¤±è´¥"
          fi

      - name: Push changes to origin
        if: steps.commit_info.outputs.has_updates == 'true' && steps.sync_result.outputs.sync_success == 'true'
        run: |
          echo "æŽ¨é€å˜æ›´åˆ°origin..."
          git push origin main --force-with-lease
          echo "âœ… æˆåŠŸæŽ¨é€åˆ°è¿œç¨‹ä»“åº“"

      - name: Create issue on sync failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ ä¸Šæ¸¸åŒæ­¥å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## åŒæ­¥å¤±è´¥æŠ¥å‘Š
            
            **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}
            
            **ä¸Šæ¸¸ä»“åº“**: https://github.com/engd66/PyramidStore
            **æœ¬åœ°æäº¤**: ${{ steps.commit_info.outputs.local_short }}
            **ä¸Šæ¸¸æäº¤**: ${{ steps.commit_info.outputs.upstream_short }}
            
            è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŽŸå› ï¼š
            ${context.payload.repository.html_url}/actions/runs/${context.runId}
            
            ---
            *æ­¤issueç”±è‡ªåŠ¨åŒæ­¥å·¥ä½œæµåˆ›å»º*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['sync-failure', 'automated']
            });

      - name: Generate summary
        if: always()
        run: |
          echo "# ðŸ”„ ä¸Šæ¸¸ä»“åº“åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸ä»“åº“**: [PyramidStore](https://github.com/engd66/PyramidStore)" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC ($(date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit_info.outputs.has_updates }}" == "true" ]; then
            if [ "${{ steps.sync_result.outputs.sync_success }}" == "true" ]; then
              echo "## âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- **åŒæ­¥æ–¹å¼**: ${{ steps.sync_result.outputs.sync_method }}" >> $GITHUB_STEP_SUMMARY
              echo "- **æ–°æäº¤æ•°é‡**: ${{ steps.commit_info.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
              echo "- **æœ€æ–°å˜æ›´**: ${{ steps.commit_info.outputs.upstream_message }}" >> $GITHUB_STEP_SUMMARY
              echo "- **å˜æ›´ä½œè€…**: ${{ steps.commit_info.outputs.upstream_author }}" >> $GITHUB_STEP_SUMMARY
              
              # SitesåŒæ­¥ä¿¡æ¯
              if [ "${{ steps.sync_sites.outputs.sites_sync_needed }}" == "true" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ðŸ”§ Sitesé…ç½®åŒæ­¥" >> $GITHUB_STEP_SUMMARY
                if [ "${{ steps.sync_sites.outputs.sites_sync_success }}" == "true" ]; then
                  if [ "${{ steps.sync_sites.outputs.sites_changes }}" == "true" ]; then
                    echo "- âœ… sitesé…ç½®å·²æ›´æ–°: spider.json â†’ moyun.json" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- â„¹ï¸ sitesé…ç½®å·²æ˜¯æœ€æ–°" >> $GITHUB_STEP_SUMMARY
                  fi
                else
                  echo "- âŒ sitesé…ç½®åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "## âŒ åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## â„¹ï¸ æ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æœ¬åœ°æäº¤**: \`${{ steps.commit_info.outputs.local_short }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸æäº¤**: \`${{ steps.commit_info.outputs.upstream_short }}\`" >> $GITHUB_STEP_SUMMARY